<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books Report - LibraryPNC</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/report_book.css">
</head>

<body>
    <main>
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="ri-file-list-3-line"></i>
                    Books Report
                </h1>
                <div class="page-actions">
                    <button class="btn btn-primary" id="print-btn">
                        <i class="ri-printer-line"></i> Print Report
                    </button>
                    <button class="btn btn-outline" id="export-btn">
                        <i class="ri-download-line"></i> Export CSV
                    </button>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="ri-book-line"></i>
                    </div>
                    <div class="stat-value" id="total-books">
                        {% if books %}
                        {{ books|length }}
                        {% else %}
                        0
                        {% endif %}
                    </div>
                    <div class="stat-label">Total Books</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="ri-checkbox-circle-line"></i>
                    </div>
                    <div class="stat-value" id="available-books">
                        {% if books %}
                        {{ books|selectattr("3", "equalto", "Available")|list|length }}
                        {% else %}
                        0
                        {% endif %}
                    </div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="ri-time-line"></i>
                    </div>
                    <div class="stat-value" id="borrowed-books">
                        {{ total_borrowed|default(0) }}
                    </div>
                    <div class="stat-label">Borrowed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon danger">
                        <i class="ri-alert-line"></i>
                    </div>
                    <div class="stat-value" id="reserved-books">
                        {{ total_reserved|default(0) }}
                    </div>
                    <div class="stat-label">Reserved</div>
                </div>
            </div>

            <div class="report-container">
                <div class="report-header">
                    <h2 class="report-title">Book Inventory</h2>
                    <div class="report-actions">
                        <div class="search-box">
                            <i class="ri-search-line"></i>
                            <input type="text" id="search-input" placeholder="Search books...">
                        </div>
                        <select id="status-filter" class="btn btn-outline" style="padding: 12px 15px;">
                            <option value="all">All Status</option>
                            <option value="Available">Available</option>
                            <option value="Borrowed">Borrowed</option>
                            <option value="Reserved">Reserved</option>
                        </select>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="books-table">
                            {% if books %}
                            {% for book in books %}
                            <tr>
                                <td>{{ book[0] }}</td>
                                <td>{{ book[1] }}</td>
                                <td>{{ book[2] }}</td>
                                <td>
                                    <span class="status-badge status-{{ book[3]|lower }}">
                                        {{ book[3] }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="4">
                                    <div class="empty-state">
                                        <i class="ri-inbox-line"></i>
                                        <h3>No Books Found</h3>
                                        <p>There are no books in the library inventory at the moment.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <button id="prev-page" disabled>
                        <i class="ri-arrow-left-s-line"></i>
                    </button>
                    <button class="active">1</button>
                    <button>2</button>
                    <button>3</button>
                    <button id="next-page">
                        <i class="ri-arrow-right-s-line"></i>
                    </button>
                </div>
            </div>

            <!-- ==== ADMIN ANALYTICS (Recent Activity) ==== -->
            <div class="analytics-container"
                style="margin-top: 2rem; padding: 1.5rem; background: #f9f9fb; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <h2 class="page-title" style="font-size: 1.4rem; margin-bottom: 1rem; color: rgb(128, 85, 128);">
                    <i class="ri-bar-chart-line"></i> Recent Activity
                </h2>

                {% if analytics %}
                <ul class="analytics-list"
                    style="list-style:none; padding:0; max-height:300px; overflow-y:auto; margin:0;">
                    {% for a in analytics %}
                    <li style="padding:8px 0; border-bottom:1px solid #eee; cursor:pointer;" {% if not a[3]
                        %}onclick="markAnalyticsSeen({{ a[0] }})" {% endif %}>
                        {% if not a[3] %}<strong style="color:#e74c3c;">New</strong>{% endif %}
                        {{ a[1] }} <small style="color:#777;">— {{ a[2] }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-center text-muted py-4" style="font-style:italic;">No recent activity.</p>
                {% endif %}
            </div>
            <!-- End Analytics -->

        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const booksTable = document.getElementById('books-table');
            const tableRows = booksTable.getElementsByTagName('tr');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const pageButtons = document.querySelectorAll('.pagination button:not(#prev-page):not(#next-page)');
            let currentPage = 1;
            const itemsPerPage = 10;

            function filterBooks() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value.toLowerCase();
                let visibleRows = [];

                for (let i = 0; i < tableRows.length; i++) {
                    const row = tableRows[i];
                    const cells = row.getElementsByTagName('td');
                    if (cells.length === 0) continue; // Skip empty state

                    let found = false;
                    for (let j = 0; j < cells.length; j++) {
                        const cellText = cells[j].textContent.toLowerCase();
                        if (cellText.includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }

                    if (found && statusValue !== 'all') {
                        const statusCell = cells[3];
                        const statusText = statusCell.textContent.toLowerCase();
                        if (!statusText.includes(statusValue)) {
                            found = false;
                        }
                    }

                    row.style.display = found ? '' : 'none';
                    if (found) visibleRows.push(row);
                }

                // Update pagination based on visible rows
                updatePagination(visibleRows);
            }

            function updatePagination(visibleRows) {
                const totalPages = Math.max(1, Math.ceil(visibleRows.length / itemsPerPage));
                currentPage = Math.min(currentPage, totalPages);

                // Hide/show rows based on current page
                visibleRows.forEach((row, index) => {
                    row.style.display = (index >= (currentPage - 1) * itemsPerPage && index < currentPage * itemsPerPage) ? '' : 'none';
                });

                // Update page buttons
                pageButtons.forEach(button => {
                    const pageNum = parseInt(button.textContent);
                    button.style.display = (pageNum <= totalPages) ? '' : 'none';
                    button.classList.toggle('active', pageNum === currentPage);
                });

                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            }

            searchInput.addEventListener('input', filterBooks);
            statusFilter.addEventListener('change', filterBooks);

            pageButtons.forEach(button => {
                button.addEventListener('click', function () {
                    currentPage = parseInt(this.textContent);
                    filterBooks();
                });
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    filterBooks();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                if (currentPage < Math.ceil(tableRows.length / itemsPerPage)) {
                    currentPage++;
                    filterBooks();
                }
            });

            // Initialize
            filterBooks();

            // --- Existing Toast Function (unchanged) ---
            function showToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
            <div class="toast-content">
                <i class="ri-${type === 'success' ? 'check' : 'information'}-line"></i>
                <span>${message}</span>
            </div>
        `;
                toast.style.cssText = `
            position: fixed; bottom: 20px; right: 20px;
            background: ${type === 'success' ? 'var(--success)' : 'var(--warning)'};
            color: white; padding: 12px 20px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000;
            display: flex; align-items: center; gap: 10px; font-weight: 500;
            animation: slideInRight 0.3s ease;
        `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);

                if (!document.getElementById('toast-animations')) {
                    const style = document.createElement('style');
                    style.id = 'toast-animations';
                    style.textContent = `
                @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
            `;
                    document.head.appendChild(style);
                }
            }

            // --- Mark Analytics Seen (unchanged) ---
            window.markAnalyticsSeen = function (id) {
                const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                fetch(`/mark-analytics-seen/${id}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': token,
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.status === 204) {
                            location.reload();
                        } else {
                            showToast('Failed to mark as read.', 'warning');
                        }
                    })
                    .catch(() => showToast('Network error.', 'warning'));
            };
        });</script>

    <!-- Add Jinja filter for date formatting -->
    {% raw %}
    <script>
        // Add strftime filter to Jinja (client-side fallback)
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('small').forEach(el => {
                const text = el.textContent;
                if (text.includes('—')) {
                    const parts = text.split('—');
                    if (parts[1]) {
                        const date = new Date(parts[1].trim());
                        if (!isNaN(date)) {
                            el.textContent = '— ' + date.toLocaleString('en-US', {
                                month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
                            });
                        }
                    }
                }
            });
        });
    </script>
    {% endraw %}
</body>

</html>